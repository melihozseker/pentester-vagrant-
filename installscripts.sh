#! /usr/bin/env bash

[ -n "$DEBUG" ] && set -x
###########################################################################################
### install apache tomcat server
# wget --progress=bar:force http://mirror.symnds.com/software/Apache/tomcat/tomcat-7/v7.0.53/bin/apache-tomcat-7.0.53.tar.gz
# tar -zxvf apache-tomcat-7.0.53.tar.gz
# mv apache-tomcat-7.0.53/ /usr/share/tomcat7

# sed -i '2i JAVA_HOME="/usr/lib/jvm/java-7-openjdk-i386"' /usr/share/tomcat7/bin/catalina.sh
# sed -i '3i JRE_HOME="/usr/lib/jvm/java-7-openjdk-i386/jre"' /usr/share/tomcat7/bin/catalina.sh

#setup tomcat user groups
# sed -i '/<tomcat-users>/a\
#   <role rolename="manager"/> \
#   <user username="tomcat" password="tomcat" roles="manager"/> \
#   <role rolename="webgoat_basic"/> \
#   <role rolename="webgoat_admin"/> \
#   <role rolename="webgoat_user"/> \
#   <role rolename="tomcat"/> \
#   <user password="webgoat" roles="webgoat_admin" username="webgoat"/> \
#   <user password="basic" roles="webgoat_user,webgoat_basic" username="basic"/> \
#   <user password="tomcat" roles="tomcat" username="tomcat"/> \
#   <user password="guest" roles="webgoat_user" username="guest"/>' /etc/tomcat7/tomcat-users.xml

# create tomcat database
# mkdir /usr/share/tomcat7/db
# chown vagrant:vagrant /usr/share/tomcat7/db

#create and copy tomcat startup stript
# wget --progress=bar:force https://raw.githubusercontent.com/p00gz/vagrant-pentester/master/tomcat7
# mv tomcat7 /etc/init.d/tomcat7
# chmod 755 /etc/init.d/tomcat7


#create symbolic link to the startup folders
# ln -s /etc/init.d/tomcat7 /etc/rc1.d/K99tomcat
# ln -s /etc/init.d/tomcat7 /etc/rc2.d/S99tomcat
/etc/init.d/tomcat7 restart


###############################################################################################
### Bodgeit Store installation

if [[ -f "/vagrant/download/bodgeit.1.4.0.zip" ]];
  then
    echo "Bodgeit already downloaded"
  else
    wget --progress=bar:force http://bodgeit.googlecode.com/files/bodgeit.1.4.0.zip -O /vagrant/download/bodgeit.1.4.0.zip
fi

if [[ -f "/var/lib/tomcat7/webapps/bodgeit.war" ]];
  then
    echo "/var/lib/tomcat7/webapps/bodgeit.war present"
  else
    unzip /vagrant/download/bodgeit.1.4.0.zip -d /var/lib/tomcat7/webapps
fi
# mv bodgeit.war /var/lib/tomcat7/webapps

# go to http://localhost:8999/bodgeit

###############################################################################################
### installing bWAPP (buggy web application)

if [[ -f "/vagrant/download/target.zip" ]];
  then
    echo "bWAPP already downloaded"
  else
    wget --progress=bar:force "http://sourceforge.net/projects/bwapp/files/latest/download?source=files" -O /vagrant/download/target.zip
fi

if [[ -d "/var/www/bWAPP" ]];
  then
    echo "/var/www/bWAPP present"
  else
    unzip /vagrant/download/target.zip -d /var/www
fi

chmod 777 /var/www/bWAPP/passwords/
chmod 777 /var/www/bWAPP/images/
sed -i 's/^$db_password.*/$db_password\=\"mysql";/' /var/www/bWAPP/admin/settings.php

# go to localhost:8888/bWAPP/install.php
# follow the "click here to install bWAPP" link
# database will be created.
# login: bee
# password: bug

################################################################################################
### Exploit KB installation

if [[ -f "/vagrant/download/exploit.tar.gz" ]];
  then
    echo "Exploit KB tar already downloaded"
  else
    wget --progress=bar:force http://sourceforge.net/projects/exploitcoilvuln/files/src/exploit-wa.tar.gz/download -O /vagrant/download/exploit.tar.gz
fi

if [[ -d "/var/www/exploit" ]];
  then
    echo "/var/www/exploit present"
  else
    mkdir /var/www/exploit
    tar -zxvf /vagrant/download/exploit.tar.gz -C /var/www/exploit
fi

sed -i 's/^$dbpassword.*/$dbpassword = "mysql";/' /var/www/exploit/config.php

EXP_DBNAME="exploit"
EXP_DBEXISTS=$(mysql -uroot -pmysql --batch --skip-column-names -e "SHOW DATABASES LIKE '"$EXP_DBNAME"';" | grep "$EXP_DBNAME" > /dev/null; echo "$?")
if [ $EXP_DBEXISTS -eq 0 ];
  then
    echo "A database with the name $EXP_DBNAME already exists"
  else
    mysql -uroot -pmysql -e "create database exploit"
    mysql -uroot -pmysql exploit < /var/www/exploit/database/exploit.sql
fi


#go to http://localhost:8888/exploit/index.php

#################################################################################################
### SQLi Labs installation

if [[ -d "/var/www/sqli-labs" ]];
  then
    echo "/var/www/sqli-labs present"
  else
    git clone https://github.com/Audi-1/sqli-labs.git /var/www/sqli-labs
fi

sed -i 's/^$dbpass.*/$dbpass = "mysql";/' /var/www/sqli-labs/sql-connections/db-creds.inc

# go to http://localhost:8888/sqli-labs/index.html
# Click "Setup/reset Database for labs"

#################################################################################################
### installing Wavsep

if [[ -f "/vagrant/download/wavsep-v1.2-war-linux.zip" ]];
  then
    echo "Wavsep already downloaded"
  else
    wget --progress=bar:force https://wavsep.googlecode.com/files/wavsep-v1.2-war-linux.zip -O /vagrant/download/wavsep-v1.2-war-linux.zip
fi

if [[ -f "/var/lib/tomcat7/webapps/wavsep.war" ]];
  then
    echo "/var/lib/tomcat7/webapps/wavsep.war present"
  else
    unzip /vagrant/download/wavsep-v1.2-war-linux.zip -d /var/lib/tomcat7/webapps
fi
# mv wavsep.war /var/lib/tomcat7/webapps


# go to: http://localhost:8999/wavsep/wavsep-install/install.jsp
# username: root
# password: mysql
# host: localhost
# port: 3306
# Click submit
# go to: http://localhost:8999/wavsep/

################################################################################################
### owasp web goat installation

if [[ -f "/vagrant/download/WebGoat.war" ]];
  then
    echo "WebGoat already downloaded"
  else
    wget --progress=bar:force https://github.com/WebGoat/WebGoat-Legacy/releases/download/v6.0.1/WebGoat-6.0.1.war -O /vagrant/download/WebGoat.war
fi

if [[ -f "/var/lib/tomcat7/webapps/WebGoat.war" ]];
  then
    echo "/var/lib/tomcat7/webapps/WebGoat.war present"
  else
    cp /vagrant/download/WebGoat.war /var/lib/tomcat7/webapps/WebGoat.war
fi
# mv WebGoat-6.0.1.war WebGoat.war
# mv WebGoat.war /var/lib/tomcat7/webapps

# go to  localhost:8999/WebGoat/attack
# username: webgoat
# password: webgoat
# if you get locked out for entering the wrong password close the browser completely and reload page

